<?xml version="1.0"?>
<launch>
    <arg name="robot_id" default="1" />
    <arg name="tf_prefix" value="robot$(arg robot_id)"/>

      <!-- launch robot_pose_publisher -->
      <node pkg="robot_pose_publisher" type="robot_pose_publisher" name="robot_pose_publisher" respawn="true">
        <param name="~map_frame" value="/map_laser2d"/>
        <!-- param name="~base_frame" value="$(arg tf_prefix)/base_link"/ -->
        <param name="~base_frame" value="$(arg tf_prefix)/steer_link"/>
      </node>

      <!-- Filters out laser points hitting robot frame/wheels-->
      <node pkg="laser_filters" type="scan_to_scan_filter_chain" name="laser2d_floor_filter">
        <rosparam command="load" file="$(find base_simulation)/params/safety_laser_filter.yaml" />
        <remap from="scan" to="/$(arg tf_prefix)/sensors/laser2d_floor" />
        <remap from="scan_filtered" to="/$(arg tf_prefix)/sensors/laser2d_floor_fil" />
      </node>
      
      <node pkg="laser_filters" type="scan_to_scan_filter_chain" name="laser2d_top_filter">
        <rosparam command="load" file="$(find base_simulation)/params/uol_nav_laser_filter.yaml" />
        <remap from="scan" to="/$(arg tf_prefix)/sensors/laser2d_top" />
        <remap from="scan_filtered" to="/$(arg tf_prefix)/sensors/laser2d_top_fil" />
      </node>

    <group ns="$(arg tf_prefix)">

        <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen" clear_params="true">
            <remap from="cmd_vel" to="/$(arg tf_prefix)/control/controller/cmd_vel"/>
            <remap from="odom" to="/$(arg tf_prefix)/odom"/>

            <!--Parameters-->

            <!--Local planner-->
            <param name="controller_frequency" value="5.0"/>
            <param name="controller_patience" value="15.0"/>
            <param name="planner_frequency" value="0.5"/>
            <rosparam file="$(find iliad_launch_system)/config/move_base/dwa/dwa_planner_ros.yaml"      command="load"/>
            <rosparam file="$(find iliad_launch_system)/config/move_base/dwa/dwa_move_base_params.yaml" command="load"/>
            
            <rosparam file="$(find iliad_launch_system)/config/move_base/costmap_common_params.yaml" command="load" ns="global_costmap"/>
            <!-- change dwa parameters that is robot-dependant -->
            <rosparam param="global_costmap/robot_base_frame" subst_value="True">
            <!-- $(arg tf_prefix)/base_link -->
                $(arg tf_prefix)/steer_link
            </rosparam>
            <rosparam param="global_costmap/obstacle_layer/laser_scan_sensor/sensor_frame" subst_value="True">
                $(arg tf_prefix)/laser2d_floor_link
            </rosparam>
            <rosparam param="global_costmap/obstacle_layer/laser_scan_sensor/topic" subst_value="True">
                /$(arg tf_prefix)/sensors/laser2d_floor_fil
            </rosparam>
            <rosparam param="global_costmap/global_obstacle_layer/laser_scan_sensor/sensor_frame" subst_value="True">
                $(arg tf_prefix)/laser2d_floor_link
            </rosparam>
            <rosparam param="global_costmap/global_obstacle_layer/laser_scan_sensor/topic" subst_value="True">
                /$(arg tf_prefix)/sensors/laser2d_floor_fil
            </rosparam>

            <rosparam file="$(find iliad_launch_system)/config/move_base/costmap_common_params.yaml" command="load" ns="local_costmap"/>
            <!-- change dwa parameters that is robot-dependant -->
            <rosparam param="local_costmap/robot_base_frame" subst_value="True">
            <!-- $(arg tf_prefix)/base_link -->
                $(arg tf_prefix)/steer_link
            </rosparam>
            <rosparam param="local_costmap/obstacle_layer/laser_scan_sensor/sensor_frame" subst_value="True">
                $(arg tf_prefix)/laser2d_floor_link
            </rosparam>
            <rosparam param="local_costmap/obstacle_layer/laser_scan_sensor/topic" subst_value="True">
                /$(arg tf_prefix)/sensors/laser2d_floor_fil
            </rosparam>
            <rosparam param="local_costmap/global_obstacle_layer/laser_scan_sensor/sensor_frame" subst_value="True">
                $(arg tf_prefix)/laser2d_floor_link
            </rosparam>
            <rosparam param="local_costmap/global_obstacle_layer/laser_scan_sensor/topic" subst_value="True">
                /$(arg tf_prefix)/sensors/laser2d_floor_fil
            </rosparam>
                    
            <rosparam file="$(find iliad_launch_system)/config/move_base/local_costmap_params.yaml"  command="load"/>
            <rosparam file="$(find iliad_launch_system)/config/move_base/global_costmap_params.yaml" command="load"/>
    	    <rosparam file="$(find iliad_launch_system)/config/move_base/nav_fn_ros.yaml"            command="load" />

        </node>
        </group>

</launch>
